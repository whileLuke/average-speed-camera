<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Route Tracker</title>

<style>
    :root {
        --bg: #f2f2f7;
        --card: #ffffff;
        --accent: #007aff;
        --text: #1c1c1e;
        --subtle: #6c6c70;
        --radius: 18px;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
        background: var(--bg);
        color: var(--text);
    }

    .container {
        padding: 16px;
        max-width: 540px;
        margin: auto;
    }

    h1 {
        font-size: 24px;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .card {
        background: var(--card);
        padding: 16px;
        border-radius: var(--radius);
        margin-bottom: 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    label {
        font-size: 14px;
        color: var(--subtle);
        display: block;
        margin-bottom: 4px;
    }

    input {
        width: 100%;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #d1d1d6;
        margin-bottom: 12px;
        font-size: 16px;
        box-sizing: border-box;
    }

    button {
        width: 100%;
        background: var(--accent);
        color: white;
        padding: 12px;
        font-size: 16px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        margin-top: 4px;
    }

    .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }

    .stat {
        background: var(--card);
        padding: 16px;
        border-radius: var(--radius);
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .stat-value {
        font-size: 22px;
        font-weight: 600;
        margin-top: 6px;
    }

    /* Gauge */
    .gauge-card {
        background: var(--card);
        padding: 20px;
        border-radius: var(--radius);
        margin-top: 20px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.09);
    }

    .gauge {
        width: 220px;
        height: 110px;
        margin: 0 auto;
    }

    #needle {
        transform-origin: 110px 110px;
        transition: transform 0.25s ease-out;
    }

    .gauge-value {
        margin-top: 10px;
        font-size: 24px;
        font-weight: 600;
    }
</style>
</head>

<body>
<div class="container">
    <h1>Route Tracker</h1>

    <div class="card">
        <label>Destination Latitude</label>
        <input id="destLat" placeholder="-33.865" />

        <label>Destination Longitude</label>
        <input id="destLon" placeholder="151.209" />

        <label>Arrival Time</label>
        <input id="arrival" type="datetime-local" />

        <label>Speed Limit (optional km/h)</label>
        <input id="speedLimit" placeholder="100" />

        <button id="setStart">Use My Location as Start</button>
        <button id="setStartManual">Enter Start Manually</button>
        <button id="begin">Start Tracking</button>
    </div>

    <div class="stats">
        <div class="stat">
            <div>Distance Left</div>
            <div id="distLeft" class="stat-value">--</div>
        </div>
        <div class="stat">
            <div>Distance Travelled</div>
            <div id="distTrav" class="stat-value">--</div>
        </div>
    </div>

    <div class="gauge-card">
        <div>Required Avg Speed</div>

        <!-- Half-circle SVG gauge -->
        <svg class="gauge" viewBox="0 0 220 110">
            <path d="M10 110 A100 100 0 0 1 210 110" fill="#e5e5ea" />
            <line id="needle"
                  x1="110" y1="110"
                  x2="110" y2="20"
                  stroke="#007aff" stroke-width="6"
                  stroke-linecap="round" />
        </svg>

        <div id="reqSpeed" class="gauge-value">--</div>
    </div>
</div>


<script>
/* ------------------------------ Helpers ------------------------------ */

function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;

    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

let start = null;
let dest = null;
let lastGPS = null;
let totalTravelled = 0;
let tracking = false;
let lastOSRMCall = 0;


/* ------------------------------ Start selection ------------------------------ */

document.getElementById("setStart").onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
        start = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
        };
        alert("Start location set.");
    });
};

document.getElementById("setStartManual").onclick = () => {
    const lat = prompt("Enter start latitude:");
    const lon = prompt("Enter start longitude:");
    if (lat && lon) {
        start = { lat: parseFloat(lat), lon: parseFloat(lon) };
        alert("Start location set manually.");
    }
};


/* ------------------------------ Main tracking ------------------------------ */

document.getElementById("begin").onclick = () => {
    const dLat = parseFloat(document.getElementById("destLat").value);
    const dLon = parseFloat(document.getElementById("destLon").value);
    const arrival = document.getElementById("arrival").value;

    if (!start) return alert("Select a start location first.");
    if (!dLat || !dLon) return alert("Enter destination coordinates.");
    if (!arrival) return alert("Enter arrival time.");

    dest = { lat: dLat, lon: dLon };
    tracking = true;

    navigator.geolocation.watchPosition(updatePosition, console.error, {
        enableHighAccuracy: true,
        maximumAge: 1000
    });
};


async function updatePosition(pos) {
    if (!tracking) return;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if (lastGPS) {
        totalTravelled += haversine(lastGPS.lat, lastGPS.lon, lat, lon);
    }
    lastGPS = { lat, lon };

    const now = Date.now();
    const arrivalTime = new Date(document.getElementById("arrival").value).getTime();
    const hoursLeft = (arrivalTime - now) / 3600000;

    /* ----------- Distance remaining via OSRM every 10 seconds ----------- */
    const nowSec = Date.now();
    let remaining = haversine(lat, lon, dest.lat, dest.lon);

    if (nowSec - lastOSRMCall > 10000) {
        lastOSRMCall = nowSec;

        const url = `https://router.project-osrm.org/route/v1/driving/${lon},${lat};${dest.lon},${dest.lat}?overview=false`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            if (data && data.routes && data.routes.length > 0) {
                remaining = data.routes[0].distance; // metres
            }
        } catch (e) {
            console.log("OSRM error, using straight-line fallback.");
        }
    }

    /* ----------- Required average speed ----------- */
    let required = "--";
    if (hoursLeft > 0) {
        required = (remaining / 1000) / hoursLeft; // km/h
    }

    /* ----------- Update UI ----------- */
    document.getElementById("distLeft").textContent = (remaining/1000).toFixed(2) + " km";
    document.getElementById("distTrav").textContent = (totalTravelled/1000).toFixed(2) + " km";

    if (required !== "--") {
        document.getElementById("reqSpeed").textContent = required.toFixed(1) + " km/h";
        updateGauge(required);
    } else {
        document.getElementById("reqSpeed").textContent = "--";
    }
}


/* ------------------------------ Gauge logic ------------------------------ */

function updateGauge(speed) {
    const max = 150;
    const clamped = Math.min(max, Math.max(0, speed));
    const percent = clamped / max;
    const angle = -90 + (180 * percent);

    document.getElementById("needle").style.transform = `rotate(${angle}deg)`;
}

</script>

</body>
</html>